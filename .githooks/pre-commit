#!/bin/sh
set -e

echo "pre-commit: running checks..."

echo "  formatting..."
# Collect staged Rust files
STAGED_FILES=$(git diff --cached --name-only -- '*.rs')

if [ -n "$STAGED_FILES" ]; then
    # Run rustfmt directly on those files
    rustfmt $STAGED_FILES

    # Re-stage formatted files
    git add $STAGED_FILES
fi

echo "  clippy..."
CLIPPY_OUT=$(cargo clippy --workspace --all-targets --quiet -- -D warnings 2>&1) || {
    echo "clippy failed:"
    echo "$CLIPPY_OUT"
    exit 1
}

echo "  tests..."
if ! TEST_OUT=$(cargo test --workspace -q 2>&1); then
    echo "tests failed:"
    echo "$TEST_OUT"
    exit 1
fi

echo "pre-commit: all checks passed"
exit 0